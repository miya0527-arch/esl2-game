<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ESL2 ‚Äì Do/Does Game (Auto Upload ‚Ä¢ Fixed URL)</title>
<style>
  :root{
    --primary:#4f46e5; --pill-bg:#eef2ff; --pill-fg:#3730a3; --bar:#60a5fa;
    --card:#fff; --ink:#111; --muted:#666; --border:#ddd; --bg:#fafafa;
  }
  body{font-family:Arial,Helvetica,sans-serif;margin:20px;background:var(--bg);color:var(--ink)}
  h1{font-size:26px;margin:0 0 10px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  select,button,input{font-size:14px;padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:#fff}
  button{cursor:pointer}
  button.primary{background:var(--primary);color:#fff;border:none}
  button.danger{background:#dc2626;color:#fff;border:none}
  button:disabled{opacity:.5;cursor:not-allowed}
  .pill{background:var(--pill-bg);color:var(--pill-fg);border-radius:20px;padding:4px 10px;font-size:12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin:12px 0;max-width:1200px}
  .q{font-size:22px;margin:8px 0}
  .choices{display:flex;flex-wrap:wrap;gap:10px}
  .choices button{padding:10px 14px;font-size:18px;border:2px solid var(--border);border-radius:12px;background:#fff}
  .choices button.correct{background:#e6ffed;border-color:#86efac}
  .choices button.wrong{background:#ffe6e6;border-color:#fca5a5}
  .feedback{font-weight:bold;margin-top:10px}
  .ok{color:#16a34a}.bad{color:#dc2626}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border:1px solid var(--border);padding:6px}
  th{background:#f1f5f9}
  .muted{color:var(--muted)}
  .badge{display:inline-block;margin-left:6px;background:#fde68a;color:#7c2d12;border-radius:999px;padding:2px 8px;font-size:11px}
  #pic{margin-top:10px;height:180px;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .imgwrap{width:100%;height:180px;display:flex;align-items:center;justify-content:center}
  .imgwrap img{max-height:170px;max-width:92%;object-fit:contain;border-radius:10px;border:1px solid #e5e7eb;background:#fff}
  .timerBox{display:flex;align-items:center;gap:10px;margin:6px 0 8px}
  .timepill{background:#fef3c7;color:#92400e;border-radius:20px;padding:4px 10px;font-size:14px}
  .barwrap{flex:1;height:10px;background:#eee;border-radius:999px;overflow:hidden}
  .bar{height:100%;width:100%;background:var(--bar);transition:width .2s linear}
  #confettiCanvas{position:fixed;inset:0;width:100%;height:100%;pointer-events:none;z-index:9999}
  .bigNext{margin-top:12px;width:100%;padding:14px 16px;font-size:20px;border-radius:12px;border:none}
</style>
</head>
<body>
<h1>ESL2 ‚Äì Do/Does Game</h1>

<!-- Áé©ÂÆ∂ËàáÊ®°Âºè -->
<div class="card">
  <div class="toolbar">
    <label>Player: <input id="playerName" placeholder="Enter name" /></label>
    <button id="btnSetPlayer" class="primary">Set / Switch Player</button>

    <label>Mode:
      <select id="mode">
        <option value="mix">Mix</option>
        <option value="Q">A) Do/Does</option>
        <option value="AUX">B) do / don't / does / doesn't</option>
        <option value="SUBJ">C) Answer Subject</option>
        <option value="YN">D) Yes / No</option>
      </select>
    </label>

    <label>Pictures:
      <select id="picMode">
        <option value="images" selected>External Images (color)</option>
        <option value="icons">Icons (fallback)</option>
      </select>
    </label>

    <button id="btnNew" class="primary" disabled>New Question</button>
    <button id="btnReveal">Reveal</button>
    <button id="btnReset">Reset</button>

    <span class="pill">Current: <span id="currentPlayer" class="muted">‚Äî</span></span>
    <span class="pill" id="streakPill">Streak: 0</span>
    <span class="pill" id="score">Score: 0</span>
    <span class="pill" id="attempts">Attempts: 0</span>
    <span class="pill" id="accuracy">Accuracy: 0%</span>
  </div>
</div>

<!-- ËÄÅÂ∏´Â∑•ÂÖ∑ÔºàSend/Export ÁÑ° PINÔºõImport/Clear Ë¶Å PINÔºâ -->
<div class="card">
  <h3>Admin / Transfer</h3>
  <div class="toolbar">
    <button id="btnSend" class="primary" title="Auto upload to teacher sheet (no PIN)">üì° Send to Teacher (Auto)</button>
<button id="btnPing" class="btn btn-info">üîé Test Upload</button>
    <button id="btnExport" title="Export all data (no PIN)">üíæ Export JSON (Backup)</button>
    <button id="btnImport" title="Import JSON (need PIN)">‚¨ÜÔ∏è Import JSON (PIN)</button>
    <button id="btnClearAll" class="danger" title="Clear ALL local data on THIS device (need PIN)">üóëÔ∏è Clear ALL Data (PIN)</button>
  </div>
  <div class="muted" style="margin-top:6px">Send / Export ‰∏çÈúÄ PINÔºõImport / Clear ÈúÄ PINÔºàPIN ‰∏çÈ°ØÁ§∫Ôºâ„ÄÇ</div>
</div>

<!-- Âá∫È°åÂç° -->
<div class="card" id="quizCard">
  <div id="hint">Enter player name, set player, then click ‚ÄúNew Question‚Äù.</div>
  <div class="timerBox">
    <span class="timepill">Time: <span id="timeLeft">8</span>s</span>
    <div class="barwrap"><div class="bar" id="timeBar"></div></div>
  </div>
  <div id="pic"><span class="muted">Picture will appear here.</span></div>
  <div class="muted" style="font-size:12px">Ëã•Â≠∏Ê†°Á∂≤Ë∑ØÊìãÂ§ñÂúñÔºåÂàáÂà∞„ÄåIcons (fallback)„Äç„ÄÇ</div>
  <div class="q" id="question">‚Äî</div>
  <div class="choices" id="choices"></div>
  <button id="btnNewBelow" class="primary bigNext" disabled>Next / New Question (Enter)</button>
  <div class="feedback" id="feedback"></div>
</div>

<!-- Êú¨Ê¨°ÈÅäÊà≤Á¥ÄÈåÑ -->
<div class="card">
  <h3>Game Record (This Session)</h3>
  <div class="toolbar"><button id="btnDownloadLog">‚¨áÔ∏è Download Records CSV</button></div>
  <table>
    <thead><tr><th>#</th><th>Player</th><th>Mode</th><th>Prompt</th><th>Your Answer</th><th>Correct</th><th>‚úì/‚úó</th><th>Time (s)</th></tr></thead>
    <tbody id="log"></tbody>
  </table>
</div>

<!-- ÊéíË°åÊ¶úÔºàÊâÄÊúâ‰∫∫Ôºâ -->
<div class="card">
  <h3>Leaderboard (All Players)
    <span id="leaders" class="badge"></span>
  </h3>
  <table>
    <thead>
      <tr>
        <th>Rank</th><th>Player</th><th>Attempts</th><th>Correct</th>
        <th>Total Time (s)</th><th>Avg Time (s)</th><th>Best Streak</th><th>Accuracy</th>
      </tr>
    </thead>
    <tbody id="board"></tbody>
  </table>
</div>

<!-- ÂÖ®ÈÉ®Ê≠∑Âè≤ÔºàÂèØÁØ©ÈÅ∏Ôºâ -->
<div class="card">
  <h3>All Players ‚Äì Full History</h3>
  <div class="toolbar">
    <label>Filter:
      <select id="playerFilter"><option value="__ALL__" selected>All Players</option></select>
    </label>
    <button id="btnRefreshHistory">Refresh</button>
    <button id="btnDownloadHistory">‚¨áÔ∏è Download Filtered CSV</button>
  </div>
  <table>
    <thead>
      <tr>
        <th>#</th><th>Player</th><th>Mode</th><th>Prompt</th>
        <th>Your Answer</th><th>Correct</th><th>‚úì/‚úó</th><th>Time (s)</th><th>Timestamp</th>
      </tr>
    </thead>
    <tbody id="allRecords"></tbody>
  </table>
</div>

<canvas id="confettiCanvas"></canvas>

<script>
/* ====== CONFIG ====== */
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwJ3fC0NfWKSVDi2BiRRL_FDOssm2KJlX3CvX5xRqJcn0cmrqTYVBupfaIJTCX8381G9w/exec";
const TEACHER_PIN = "EslEsl8700";
const COUNTDOWN_SECONDS = 8;
const PRAISE = ["Well done!","Good job!","You‚Äôre great!","Excellent!","Awesome!"];
const NEG_FEEDBACK = ["Oops!","Oh no!","No points!","Try again!","Not this time!"];

const items = [
  "popcorn","candy","peanuts","crackers","potato chips",
  "chalk","paint","tape","scissors","glue","paper","ribbon","string","magnets",
  "calculators","colored pencils","rubber bands","push pins","paint brushes","staplers"
];

/* 20 ÂºµÂΩ©Ëâ≤ÂúñÔºàPixabayÔºâ */
const IMAGES = {
  popcorn: "https://cdn.pixabay.com/photo/2017/08/10/23/48/popcorn-2627497_640.jpg",
  candy: "https://cdn.pixabay.com/photo/2016/03/04/12/01/candies-1239432_640.jpg",
  peanuts: "https://cdn.pixabay.com/photo/2016/11/23/15/31/peanuts-1851703_640.jpg",
  crackers: "https://cdn.pixabay.com/photo/2017/05/31/12/17/crackers-2362072_640.jpg",
  "potato chips": "https://cdn.pixabay.com/photo/2014/07/06/16/30/chips-385301_640.jpg",
  chalk: "https://cdn.pixabay.com/photo/2017/09/04/08/48/chalk-2714990_640.jpg",
  paint: "https://cdn.pixabay.com/photo/2016/11/29/05/08/paint-1869856_640.jpg",
  tape: "https://cdn.pixabay.com/photo/2015/09/05/21/51/adhesive-tape-925430_640.jpg",
  scissors: "https://cdn.pixabay.com/photo/2016/01/07/23/18/scissors-1126805_640.jpg",
  glue: "https://cdn.pixabay.com/photo/2016/04/01/11/23/glue-1301880_640.png",
  paper: "https://cdn.pixabay.com/photo/2017/08/10/03/37/paper-2610631_640.jpg",
  ribbon: "https://cdn.pixabay.com/photo/2016/11/29/03/54/ribbon-1869795_640.jpg",
  string: "https://cdn.pixabay.com/photo/2016/12/27/17/01/string-1935765_640.jpg",
  magnets: "https://cdn.pixabay.com/photo/2017/03/27/14/08/magnet-2174751_640.jpg",
  calculators: "https://cdn.pixabay.com/photo/2014/07/06/13/55/calculator-385506_1280.jpg",
  "colored pencils": "https://cdn.pixabay.com/photo/2016/06/29/08/50/pencils-1486278_640.jpg",
  "rubber bands": "https://cdn.pixabay.com/photo/2016/12/06/18/27/rubber-bands-1888888_640.jpg",
  "push pins": "https://cdn.pixabay.com/photo/2016/09/20/20/19/push-pin-1684181_640.jpg",
  "paint brushes": "https://cdn.pixabay.com/photo/2016/11/29/12/54/paint-brushes-1868992_640.jpg",
  staplers: "https://cdn.pixabay.com/photo/2016/03/05/20/01/stapler-1238997_640.jpg"
};

/* ====== Helpers ====== */
function $(sel){return document.querySelector(sel)}
function pick(arr){return arr[Math.floor(Math.random()*arr.length)]}
function cap(s){return s[0].toUpperCase()+s.slice(1)}
function twodec(x){return (Math.round(x*100)/100).toFixed(2)}
function nowISO(){ return new Date().toISOString(); }

/* ====== Subjects ====== */
const baseSubjects = [
  {q:"I",   ans:"I",   auxQ:"do",   auxAff:"do",   auxNeg:"don't"},
  {q:"you", ans:"you", auxQ:"do",   auxAff:"do",   auxNeg:"don't"},
  {q:"we",  ans:"we",  auxQ:"do",   auxAff:"do",   auxNeg:"don't"},
  {q:"they",ans:"they",auxQ:"do",   auxAff:"do",   auxNeg:"don't"},
  {q:"he",  ans:"he",  auxQ:"does", auxAff:"does", auxNeg:"doesn't"},
  {q:"she", ans:"she", auxQ:"does", auxAff:"does", auxNeg:"doesn't"}
];

/* ====== UI bits ====== */
function fallbackIcon(label){
  return `<div class="imgwrap"><div style="font-size:22px;color:#6b7280;border:1px dashed #cbd5e1;border-radius:10px;padding:10px 14px;background:#fff">${label}</div></div>`;
}
function renderPicFor(item){
  const mode = $("#picMode").value;
  const holder = $("#pic");
  holder.innerHTML = `<div class="imgwrap"><span class="muted" style="font-size:12px">Loading...</span></div>`;
  if(mode==="images" && IMAGES[item]){
    const src = IMAGES[item];
    holder.innerHTML = `
      <div class="imgwrap">
        <img alt="${item}" src="${src}"
             referrerpolicy="no-referrer" loading="eager"
             onerror="this.onerror=null; this.remove(); this.parentElement.innerHTML=\`${fallbackIcon(item)}\`">
      </div>`;
  }else{
    holder.innerHTML = fallbackIcon(item);
  }
}

/* ====== State ====== */
let score=0, attempts=0, round=0, streak=0;
let current=null, answered=false;
let timerId=null, timeLeft=COUNTDOWN_SECONDS, questionStart=0;
let currentPlayer=null;

let sessionRecords=[];
let store = { allRecords:[], allStats:{} };
let currentPlayerStreak = 0;

/* ====== Local Storage ====== */
const KEY = "esl2_portable_store_v20pics";
function loadLocal(){ try{ const v=JSON.parse(localStorage.getItem(KEY)||"{}"); if(v&&v.allRecords&&v.allStats) store=v; }catch{} }
function saveLocal(){ localStorage.setItem(KEY, JSON.stringify(store)); }

/* ====== Audio / TTS ====== */
let audioCtx=null;
function ensureAudio(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }
function beep(freq=600, dur=0.15, type='sine', vol=0.3){
  try{ ensureAudio();
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=vol;
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.05); o.stop(audioCtx.currentTime+0.06); }, dur*1000);
  }catch(e){}
}
function speak(text){
  if(!('speechSynthesis' in window)) return false;
  const u = new SpeechSynthesisUtterance(text);
  const voices = speechSynthesis.getVoices(); const pref = voices.find(v=>/en/i.test(v.lang)) || null;
  if (pref) u.voice = pref; u.rate=1; u.pitch=1; u.volume=1;
  speechSynthesis.cancel(); speechSynthesis.speak(u);
  return true;
}
function sfxCorrect(){ if(!speak(pick(PRAISE))) beep(880); }
function sfxWrong(){ if(!speak(pick(NEG_FEEDBACK))) beep(200,0.3,'square'); }

/* ====== Timer ====== */
function speakCountdown(n){ const words={3:"Three",2:"Two",1:"One"}; if(words[n]){ speak(words[n]); beep(700,0.2); } }
function resetTimer(){ clearInterval(timerId); timerId=null; timeLeft=COUNTDOWN_SECONDS; $("#timeLeft").textContent=timeLeft; $("#timeBar").style.width="100%"; }
function startTimer(){
  resetTimer(); questionStart=performance.now();
  timerId=setInterval(()=>{
    timeLeft--; $("#timeLeft").textContent=timeLeft; $("#timeBar").style.width=(timeLeft/COUNTDOWN_SECONDS*100)+"%";
    if([3,2,1].includes(timeLeft)) speakCountdown(timeLeft);
    if(timeLeft<=0){ clearInterval(timerId); timerId=null; speak("Time's up!"); beep(200,0.35,'square'); timesUp(); }
  },1000);
}
function stopTimer(){ clearInterval(timerId); timerId=null; }

/* ====== HUD ====== */
function updateHUD(){
  $("#score").textContent="Score: "+score;
  $("#attempts").textContent="Attempts: "+attempts;
  $("#accuracy").textContent="Accuracy: "+(attempts?Math.round(score/attempts*100):0)+"%";
  $("#currentPlayer").textContent=currentPlayer?currentPlayer:"‚Äî";
  $("#currentPlayer").classList.toggle("muted", !currentPlayer);
  $("#btnNew").disabled = !currentPlayer;
  $("#btnNewBelow").disabled = !currentPlayer;
  $("#streakPill").textContent = "Streak: " + streak;
}

/* ====== Question generation ====== */
function newQ(){
  if(!currentPlayer){ $("#feedback").textContent="Please set a player name first."; $("#feedback").className="feedback bad"; return; }
  round++; stopTimer();
  let m=$("#mode").value; if(m==="mix"){ m=["Q","AUX","SUBJ","YN"][Math.floor(Math.random()*4)]; }
  const subj=pick(baseSubjects);
  const item = pick(items);
  const truthYes=Math.random()<0.5;

  if(m==="Q"){
    const prompt=`____ ${subj.q} have any ${item}?`;
    const correct=(subj.auxQ==="do"?"Do":"Does");
    current={mode:"Do/Does", full:prompt, correctSet:new Set([correct]), item};
    $("#hint").textContent="Choose: Do or Does";
    $("#question").textContent=prompt; renderPicFor(item);
    renderChoices(["Do","Does"], current.correctSet);

  }else if(m==="AUX"){
    const q = `${cap(subj.auxQ)} ${subj.q} have any ${item}?`;
    const ansSubj = (subj.q==="I") ? "you" : (subj.q==="you" ? "I" : subj.ans);
    const needed = truthYes ? subj.auxAff : subj.auxNeg;
    const short = `${truthYes ? "Yes" : "No"}, ${ansSubj} ___.`;
    const prompt = q + "  " + short;
    current={mode:"Aux", full:prompt, correctSet:new Set([needed]), item};
    $("#hint").textContent="Choose: do / don't / does / doesn't";
    $("#question").textContent=prompt; renderPicFor(item);
    renderChoices(["do","does","don't","doesn't"], current.correctSet);

  }else if(m==="SUBJ"){
    const q = `${cap(subj.auxQ)} ${subj.q} have any ${item}?`;
    const auxWord=(subj.auxQ==="do")?"do":"does";
    const short=`Yes, ___ ${auxWord}.`;
    const prompt=q+"  "+short;

    let correctSet;
    if(subj.q==="you"){ correctSet=new Set(["I","we"]);
    }else if(subj.q==="we"){ correctSet=new Set(["we","you"]);
    }else if(subj.q==="I"){ correctSet=new Set(["you"]);
    }else{ correctSet=new Set([subj.ans]); }

    const options=["I","you","we","they","he","she"];
    for(let i=options.length-1;i>0;i--){const j=Math.random()*(i+1)|0; [options[i],options[j]]=[options[j],options[i]];}

    current={mode:"Answer Subject", full:prompt, correctSet, item};
    $("#hint").textContent="Choose the correct subject";
    $("#question").textContent=prompt; renderPicFor(item);
    renderChoices(options, correctSet);

  }else{ // YN
    const q = `${cap(subj.auxQ)} ${subj.q} have any ${item}?`;
    const ansSubj = (subj.q==="I") ? "you" : (subj.q==="you" ? "I" : subj.ans);
    const showNeg=Math.random()<0.5;
    const auxShown=showNeg?subj.auxNeg:subj.auxAff;
    const short=`___, ${ansSubj} ${auxShown}.`;
    const prompt=q+"  "+short;
    const correct=showNeg?"No":"Yes";
    current={mode:"Yes/No", full:prompt, correctSet:new Set([correct]), item};
    $("#hint").textContent="Choose: Yes or No";
    $("#question").textContent=prompt; renderPicFor(item);
    renderChoices(["Yes","No"], current.correctSet);
  }

  document.getElementById('quizCard').scrollIntoView({behavior:'smooth', block:'start'});
}

function renderChoices(options, correctSet){
  const box=$("#choices"); box.innerHTML="";
  options.forEach(opt=>{ const b=document.createElement("button"); b.textContent=opt; b.onclick=()=>check(opt, correctSet, b); box.appendChild(b); });
  $("#feedback").textContent=""; $("#feedback").className="feedback";
  answered=false; startTimer();
}

/* ====== Âà§ÂàÜ / Á¥ÄÈåÑ ====== */
function finishQuestion(val, correctSet, btn){
  document.querySelectorAll(".choices button").forEach(b=>{
    b.disabled=true;
    if(correctSet.has(b.textContent)) b.classList.add("correct");
    if(btn && b===btn && !correctSet.has(val)) b.classList.add("wrong");
  });
}
function pushRecord(ok, answer, correctSet){
  const elapsedMs = Math.max(0, performance.now()-questionStart);
  const rec = {round, player: currentPlayer||"(No name)", mode: current.mode, prompt: current.full,
               answer, correctShown: Array.from(correctSet).join(" / "), ok, timeSec: elapsedMs/1000, ts: nowISO()};

  // Êú¨Ê¨°
  sessionRecords.push(rec);
  const tr=document.createElement("tr");
  tr.innerHTML=`<td>${rec.round}</td><td>${rec.player}</td><td>${rec.mode}</td><td>${rec.prompt}</td><td>${rec.answer}</td><td>${rec.correctShown}</td><td>${ok?"‚úì":"‚úó"}</td><td>${twodec(rec.timeSec)}</td>`;
  $("#log").prepend(tr);

  // Á¥ØÁ©ç
  store.allRecords.push(rec);
  if(!store.allStats[rec.player]) store.allStats[rec.player]={attempts:0, correct:0, totalMs:0, bestStreak:0};
  const S = store.allStats[rec.player];
  S.attempts++; if(ok){ S.correct++; currentPlayerStreak++; if(currentPlayerStreak>S.bestStreak) S.bestStreak=currentPlayerStreak; } else { currentPlayerStreak=0; }
  S.totalMs += elapsedMs;

  saveLocal();
  renderBoard(); renderAllHistoryTable();
}
function check(val, correctSet, btn){
  if(answered) return;
  answered=true; stopTimer(); finishQuestion(val, correctSet, btn);
  attempts++; const ok=correctSet.has(val);
  if(ok){ score++; streak++; sfxCorrect(); confettiBurst(streak>=3?2.2:1); }
  else { streak=0; sfxWrong(); }
  $("#feedback").textContent = ok ? (streak>=3 ? "Combo! Great! ‚úì" : "Great! ‚úì") : "Oops! ‚úó  Correct: "+Array.from(correctSet).join(" / ");
  $("#feedback").className = ok ? "feedback ok" : "feedback bad";
  updateHUD(); pushRecord(ok, val, correctSet);
}
function timesUp(){
  if(answered||!current) return;
  answered=true; finishQuestion("(timeout)", current.correctSet, null);
  attempts++; streak=0;
  $("#feedback").textContent="‚è∞ Time's up! Correct: "+Array.from(current.correctSet).join(" / ");
  $("#feedback").className="feedback bad";
  updateHUD(); pushRecord(false, "‚Äî (timeout)", current.correctSet); sfxWrong();
}

/* ====== Êè≠Êõâ / Áé©ÂÆ∂ / ÈáçÁΩÆ ====== */
function reveal(){
  if(!current) return; stopTimer(); answered=true;
  const correctShown=Array.from(current.correctSet).join(" / ");
  $("#feedback").textContent="Answer: "+correctShown;
  $("#feedback").className="feedback ok";
  document.querySelectorAll(".choices button").forEach(b=>{ if(current.correctSet.has(b.textContent)) b.classList.add("correct"); b.disabled=true; });
}
function setPlayer(){
  const name = ($("#playerName").value||"").trim();
  if(!name){ alert("Please enter a player name."); return; }
  currentPlayer=name;
  if(!store.allStats[name]) store.allStats[name]={attempts:0, correct:0, totalMs:0, bestStreak:0};
  $("#feedback").textContent=`Ready, ${name}! Click ‚ÄúNew Question‚Äù.`; $("#feedback").className="feedback ok";
  currentPlayerStreak = 0;
  updateHUD(); renderBoard(); saveLocal();
}
function resetAll(){
  stopTimer(); score=0; attempts=0; round=0; current=null; answered=false; currentPlayer=null; streak=0; currentPlayerStreak=0;
  $("#hint").textContent="Enter player name, set player, then click ‚ÄúNew Question‚Äù.";
  $("#question").textContent="‚Äî"; $("#pic").innerHTML='<span class="muted">Picture will appear here.</span>';
  $("#choices").innerHTML=""; $("#feedback").textContent="";
  $("#mode").value="mix";
  updateHUD(); resetTimer();
}

/* ====== ÊéíË°å / Ê≠∑Âè≤ ====== */
function renderBoard(){
  const rows = Object.entries(store.allStats).map(([name, s])=>{
    const totalSec = s.totalMs/1000;
    const avg = s.attempts ? totalSec / s.attempts : 0;
    const acc = s.attempts ? (s.correct / s.attempts * 100) : 0;
    return {name, attempts:s.attempts, correct:s.correct, totalSec, avg, bestStreak:s.bestStreak||0, acc};
  })
  .sort((a,b)=> (b.correct-a.correct) || (b.bestStreak-a.bestStreak) || (a.avg-b.avg) || a.name.localeCompare(b.name));

  const tbody=$("#board"); tbody.innerHTML="";
  rows.forEach((r,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${i+1}</td><td>${r.name}</td><td>${r.attempts}</td><td>${r.correct}</td><td>${r.totalSec.toFixed(2)}</td><td>${r.avg.toFixed(2)}</td><td>${r.bestStreak}</td><td>${Math.round(r.acc)}%</td>`;
    tbody.appendChild(tr);
  });

  const byCorrect = rows.slice().sort((a,b)=> (b.correct-a.correct) || (a.avg-b.avg))[0];
  const byStreak  = rows.slice().sort((a,b)=> (b.bestStreak-a.bestStreak) || (b.correct-a.correct) || (a.avg-b.avg))[0];
  $("#leaders").innerHTML = (byCorrect||byStreak)
    ? `Most Correct: <b>${byCorrect?byCorrect.name:"‚Äî"}</b> | Best Streak: <b>${byStreak?byStreak.name:"‚Äî"}</b>`
    : "No data yet";
}
function renderAllHistoryTable(){
  const who=$("#playerFilter").value || "__ALL__";
  const rows = (who==="__ALL__") ? store.allRecords : store.allRecords.filter(r=>r.player===who);
  const tbody=$("#allRecords"); tbody.innerHTML="";
  rows.slice().reverse().forEach((r,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${rows.length-i}</td><td>${r.player}</td><td>${r.mode}</td><td>${r.prompt}</td><td>${r.answer}</td><td>${r.correctShown}</td><td>${r.ok?"‚úì":"‚úó"}</td><td>${twodec(r.timeSec)}</td><td>${r.ts.replace('T',' ').split('.')[0]}</td>`;
    tbody.appendChild(tr);
  });

  const sel=$("#playerFilter"); const keep=sel.value;
  const names=Object.keys(store.allStats).sort((a,b)=>a.localeCompare(b));
  sel.innerHTML=`<option value="__ALL__">All Players</option>` + names.map(n=>`<option value="${n}">${n}</option>`).join("");
  if(keep) sel.value=keep;
}

/* ====== CSV / Send / Import / Clear ====== */
function toCSV(rows){ const esc=s=>('"'+String(s).replace(/"/g,'""')+'"'); return rows.map(r=>r.map(esc).join(",")).join("\n"); }
function download(name, text){ const a=document.createElement("a"); a.href="data:text/csv;charset=utf-8,"+encodeURIComponent(text); a.download=name; a.click(); }
$("#btnDownloadLog").onclick=()=>{
  const header=["round","player","mode","prompt","answer","correct","ok","time_sec","timestamp"];
  const data = sessionRecords.map(r => [r.round, r.player, r.mode, r.prompt, r.answer, r.correctShown, r.ok, twodec(r.timeSec), r.ts]);
  download("records_session.csv", toCSV([header, ...data]));
};

function exportJSON(){ download("esl2_leaderboard.json", JSON.stringify(store)); }

function guardTeacher(actionName="this action"){
  const pin = prompt(`${actionName}\nEnter teacher PIN:`);
  return pin === TEACHER_PIN;
}

function importJSON(){
  if(!guardTeacher("Import JSON")) return;
  const input=document.createElement("input");
  input.type="file"; input.accept="application/json";
  input.onchange=e=>{
    const f=e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = ev=>{
      try{
        const obj = JSON.parse(ev.target.result);
        if(obj && obj.allRecords && obj.allStats){
          store = obj; saveLocal();
          renderBoard(); renderAllHistoryTable();
          alert("Imported!");
        }else alert("Invalid file.");
      }catch{ alert("Invalid JSON."); }
    };
    reader.readAsText(f);
  };
  input.click();
}

function clearAll(){
  if(!guardTeacher("Clear ALL Data")) return;
  if(!confirm("Clear ALL saved data on THIS device?")) return;
  store={allRecords:[],allStats:{}}; localStorage.removeItem(KEY);
  renderBoard(); renderAllHistoryTable(); resetAll();
  alert("All local data cleared on THIS device.");
}

/* ====== Send to Teacher (Auto) ‚Äì Âõ∫ÂÆö URL ====== */
let lastSent = 0;
async 
async function sendToTeacherAuto(){
  try {
    let rows = [];
    if (window.store && Array.isArray(store.allRecords)) {
      const start = (window.lastSentIndex || 0);
      rows = store.allRecords.slice(start);
    } else if (window.records && Array.isArray(window.records)) {
      rows = window.records;
    } else if (window.game && Array.isArray(game.records)) {
      rows = game.records;
    }
    if (!rows || rows.length === 0) {
      alert("No new records to send.");
      return;
    }

    const res = await fetch(APPS_SCRIPT_URL || GAS_URL || "https://script.google.com/macros/s/AKfycbwJ3fC0NfWKSVDi2BiRRL_FDOssm2KJlX3CvX5xRqJcn0cmrqTYVBupfaIJTCX8381G9w/exec", {
      method: "POST",
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({ rows })
    });

    let data = {};
    try { data = await res.json(); } catch (e) {}
    if (data && data.ok) {
      if (window.store && Array.isArray(store.allRecords)) {
        window.lastSentIndex = store.allRecords.length;
      }
      alert(`Sent ${data.added || rows.length} row(s). All good!`);
    } else {
      const msg = (data && data.error) ? data.error : `HTTP ${res.status}`;
      alert(`Failed: ${msg}`);
    }
  } catch (e) {
    alert("Network error: " + e.message);
  }
}

  let ok=0, fail=0;
  for(const r of rows){
    const payload = {
      answeredAt: r.ts,
      player: r.player,
      mode: r.mode,
      prompt: r.prompt,
      answer: r.answer,
      correct: r.correctShown,
      ok: r.ok ? "‚úì" : "",
      timeSec: Number(r.timeSec||0)
    };
    try{
      const res = await fetch(APPS_SCRIPT_URL, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      const t = await res.text();
      if(res.ok){ ok++; } else { fail++; console.warn("Send failed:", t); }
    }catch(e){ fail++; console.warn("Send error:", e); }
  }
  lastSent = store.allRecords.length;
  alert(`Sent ${ok} row(s). ${fail?("Failed: "+fail):"All good!"}\nCheck your Google Sheet for new rows.`);
}

/* ====== Confetti ====== */
const confettiCanvas=document.getElementById('confettiCanvas');const ctx=confettiCanvas.getContext('2d');
function sizeCanvas(){ confettiCanvas.width = innerWidth||document.documentElement.clientWidth; confettiCanvas.height = innerHeight||document.documentElement.clientHeight; }
sizeCanvas(); addEventListener('resize', sizeCanvas);
function confettiBurst(mult=1){
  const W=confettiCanvas.width,H=confettiCanvas.height;
  const colors=["#f87171","#facc15","#34d399","#60a5fa","#a78bfa","#f472b6","#fb923c"];
  const pieces=[]; const N=Math.floor(140*mult);
  for(let i=0;i<N;i++){ pieces.push({x:Math.random()*W,y:-20-Math.random()*60,w:6+Math.random()*6,h:10+Math.random()*10,vy:2+Math.random()*4,vx:(Math.random()-0.5)*4*mult,rot:Math.random()*Math.PI*2,vr:(Math.random()-0.5)*0.3,color:colors[(Math.random()*colors.length)|0],alpha:1}); }
  const start=performance.now();
  function tick(now){
    const t=(now-start)/1000; ctx.clearRect(0,0,W,H);
    pieces.forEach(p=>{ p.x+=p.vx; p.y+=p.vy+0.6*mult; p.rot+=p.vr; p.alpha=Math.max(0,1-t/(1.2+0.4*mult));
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.globalAlpha=p.alpha; ctx.fillStyle=p.color; ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); ctx.restore(); });
    if(t<(1.2+0.4*mult)) requestAnimationFrame(tick); else ctx.clearRect(0,0,W,H);
  }
  requestAnimationFrame(tick);
}

/* ====== Bindings & init ====== */
$("#btnNew").onclick=newQ; $("#btnNewBelow").onclick=newQ; $("#btnReveal").onclick=reveal; $("#btnReset").onclick=resetAll;
$("#btnSetPlayer").onclick=setPlayer;
$("#btnSend").onclick=sendToTeacherAuto; $("#btnExport").onclick=exportJSON;
$("#btnImport").onclick=importJSON; $("#btnClearAll").onclick=clearAll;
$("#btnRefreshHistory").addEventListener("click", ()=>{ renderBoard(); renderAllHistoryTable(); });
$("#btnDownloadHistory").onclick=()=>{ const who=$("#playerFilter").value||"__ALL__"; const rows=(who==="__ALL__")?store.allRecords:store.allRecords.filter(r=>r.player===who); const header=["idx","player","mode","prompt","answer","correct","ok","time_sec","timestamp"]; const data=rows.map((r,i)=>[i+1,r.player,r.mode,r.prompt,r.answer,r.correctShown,r.ok,twodec(r.timeSec),r.ts]); download(`history_${who==="__ALL__"?"all":who}.csv`, toCSV([header,...data])); };
$("#playerFilter").addEventListener("change", renderAllHistoryTable);
$("#picMode").addEventListener("change", ()=>{ if(current && current.item) renderPicFor(current.item); });

// Keyboard: Enter -> next/new
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.isComposing){
    if(!document.activeElement || document.activeElement.tagName !== 'INPUT'){
      if(currentPlayer){ e.preventDefault(); newQ(); }
    }
  }
});

loadLocal();
renderBoard(); renderAllHistoryTable();
updateHUD(); resetTimer();
if('speechSynthesis' in window){ window.speechSynthesis.onvoiceschanged = ()=>{}; }
</script>
</body>
</html>